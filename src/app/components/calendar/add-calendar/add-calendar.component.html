<div class="app-layout">
  
  <div class="top-bar">
    
    <div class="header-row">
        <div class="title-group">
            <div class="icon-badge">
                <i class="fa-regular fa-calendar"></i>
            </div>
            <div>
                <h1 class="page-title">{{ viewDate | calendarDate:(view + 'ViewTitle'):locale }}</h1>
                <p class="page-subtitle">Görev ve Servis Yönetimi</p>
            </div>
        </div>

        <div class="nav-controls">
            <button class="btn-icon" mwlCalendarPreviousView [view]="view" [(viewDate)]="viewDate" (viewDateChange)="closeOpenMonthViewDay()">
                <i class="fa-solid fa-chevron-left"></i>
            </button>
            <button class="btn-today" mwlCalendarToday [(viewDate)]="viewDate">Bugün</button>
            <button class="btn-icon" mwlCalendarNextView [view]="view" [(viewDate)]="viewDate" (viewDateChange)="closeOpenMonthViewDay()">
                <i class="fa-solid fa-chevron-right"></i>
            </button>
        </div>
    </div>

    <div class="separator"></div>

    <div class="toolbar-row">
        
        <div class="filter-strip custom-scrollbar">
            
            <button class="chip" [class.active]="selectedId === ''" (click)="loadDuties()">
                Tümü
            </button>
            <button class="chip" [class.active]="selectedId === 'cmp'" (click)="loadDutyByStatus('Tamamlandı', 'cmp')">
                <span class="dot success"></span> Bitenler
            </button>
            <button class="chip" [class.active]="selectedId === 'uncmp'" (click)="loadDutyByStatus('Tamamlanmamış', 'uncmp')">
                <span class="dot danger"></span> Bitmeyenler
            </button>
            
            <div class="divider-v"></div>

            @for (emp of employees; track emp.id) {
                <button class="chip user" 
                        [class.active]="selectedId === emp.id" 
                        (click)="loadDutyForEmployee(emp.id)">
                    <span class="avatar">{{ emp.firstName.charAt(0) }}</span>
                    {{ emp.firstName }}
                </button>
            }
        </div>

        <div class="right-actions">
            <div class="toggle-capsule">
                <button [class.active]="view === CalendarView.Month" (click)="setView(CalendarView.Month)">Ay</button>
                <button [class.active]="view === CalendarView.Week" (click)="setView(CalendarView.Week)">Hafta</button>
                <button [class.active]="view === CalendarView.Day" (click)="setView(CalendarView.Day)">Gün</button>
            </div>

            <button class="btn-primary-action" [matMenuTriggerFor]="menu">
                <i class="fa-solid fa-plus"></i> <span>Oluştur</span>
            </button>
            
            <mat-menu #menu="matMenu" xPosition="before">
                <button mat-menu-item (click)="openAddQuickDutyDialog()">
                    <i class="fa-solid fa-bolt me-2 text-warning"></i> Hızlı Görev
                </button>
                <button mat-menu-item (click)="openAddServiceDutyDialog()">
                    <i class="fa-solid fa-screwdriver-wrench me-2 text-info"></i> Servis Formu
                </button>
                <button mat-menu-item (click)="openAddDutyDialog()">
                    <i class="fa-solid fa-file-pen me-2 text-primary"></i> Detaylı Görev
                </button>
            </mat-menu>
        </div>
    </div>
  </div>

  <div class="calendar-scroll-container custom-scrollbar">
      <div class="calendar-wrapper">
          @if (view === CalendarView.Month) {
            <mwl-calendar-month-view
              [viewDate]="viewDate"
              [events]="events"
              [refresh]="refresh"
              [activeDayIsOpen]="activeDayIsOpen"
              [weekStartsOn]="1"
              [locale]="locale"
              (dayClicked)="dayClicked($event)"
              (eventClicked)="eventClicked($event)"
              (eventTimesChanged)="eventTimesChanged($event)">
            </mwl-calendar-month-view>
          }
          @if (view === CalendarView.Week) {
            <mwl-calendar-week-view
              [viewDate]="viewDate"
              [events]="events"
              [refresh]="refresh"
              [locale]="locale"
              [weekStartsOn]="1"
              [dayStartHour]="8"
              [dayEndHour]="19"
              (eventClicked)="eventClicked($event)"
              (eventTimesChanged)="eventTimesChanged($event)">
            </mwl-calendar-week-view>
          }
          @if (view === CalendarView.Day) {
            <mwl-calendar-day-view
              [viewDate]="viewDate"
              [events]="events"
              [refresh]="refresh"
              [locale]="locale"
              [dayStartHour]="0"
              [dayEndHour]="23"
              (eventClicked)="eventClicked($event)"
              (eventTimesChanged)="eventTimesChanged($event)">
            </mwl-calendar-day-view>
          }
      </div>
  </div>

  @if (showModal) {
    <div class="modal-backdrop fade show"></div>
    <div class="modal d-block fade show" tabindex="-1" (click)="closeInfoModal()">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
          <div class="modal-header border-0 pb-0">
            <h6 class="fw-bold">{{ modalData?.action }}</h6>
            <button type="button" class="btn-close" (click)="closeInfoModal()"></button>
          </div>
          <div class="modal-body">
            <pre class="bg-light p-3 rounded small">{{ modalData?.event | json }}</pre>
          </div>
        </div>
      </div>
    </div>
  }
</div>